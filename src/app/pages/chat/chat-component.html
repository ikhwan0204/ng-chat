<main class="h-100 d-flex justify-content-center align-items-center" style="background-color: #f0f0f0;">
  <div class="container py-4 h-100">
    <div class="nb-box h-100 d-flex flex-column overflow-hidden">
      
      <!-- Header -->
      <div class="p-3 d-flex justify-content-between align-items-center" style="background-color: var(--nb-accent); border-bottom: var(--nb-border);">
        <h2 class="m-0 fw-bold" style="letter-spacing: -1px; font-family: var(--nb-font-family);">SUPA_CHAT</h2>
        <button (click)="logOut()" class="nb-btn btn-sm bg-white text-danger">LOGOUT</button>
      </div>

      <!-- Chat List -->
      <div #chatContainer class="chat-messages p-4 flex-grow-1" style="overflow-y: auto; background-color: #fff;">
        @for (msg of this.chats(); track msg.id) {
          <div class="d-flex mb-4" [class.flex-row-reverse]="msg.sender === currentUser()?.id">
            
            <!-- Avatar -->
            <div class="flex-shrink-0" [class.ms-3]="msg.sender === currentUser()?.id" [class.me-3]="msg.sender !== currentUser()?.id">
               <img [src]="msg?.users?.avatar_url" class="nb-avatar" style="width: 50px; height: 50px; border: var(--nb-border); border-radius: 0; object-fit: cover;">
            </div>

            <!-- Message Body -->
            <div class="d-flex flex-column" [class.align-items-end]="msg.sender === currentUser()?.id" [class.align-items-start]="msg.sender !== currentUser()?.id" style="max-width: 70%;">
              <div class="mb-1">
                <span class="fw-bold me-2">{{msg?.users?.full_name}}</span>
                <small class="text-muted" style="font-size: 0.7rem;">{{msg?.created_at | date: 'shortTime'}}</small>
              </div>
              
              <div class="p-3" 
                   [style.background-color]="msg.sender === currentUser()?.id ? 'var(--nb-primary)' : 'var(--nb-secondary)'"
                   style="border: var(--nb-border); box-shadow: 4px 4px 0px #000; word-break: break-word;">
                {{msg?.text}}
              </div>

              <!-- Dropdown trigger -->
               @if(msg.sender === currentUser()?.id) {
                <div class="dropdown mt-1">
                  <span (click)="openDropDown(msg)" role="button" data-bs-toggle="dropdown" style="font-size: 20px; font-weight: bold; cursor: pointer;">...</span>
                  <ul class="dropdown-menu nb-box" style="border-radius: 0;">
                    <li><a class="dropdown-item fw-bold" href="#" data-bs-toggle="modal" data-bs-target="#exampleModal">DELETE</a></li>
                  </ul>
                </div>
               }
            </div>
          </div>
        } @empty {
           <div class="h-100 d-flex justify-content-center align-items-center">
             <div class="p-4 nb-box text-center" style="background-color: #eee;">
               <h4 class="fw-bold">NO MESSAGES YET</h4>
               <p>BE THE FIRST TO CHAT!</p>
             </div>
           </div>
        }
      </div>

      <!-- Footer / Input -->
      <div class="p-3" style="border-top: var(--nb-border); background-color: #f9f9f9;">
        <form [formGroup]="chatForm" (ngSubmit)="onSubmit()" class="d-flex gap-2">
          <input formControlName="chat_message" type="text" class="nb-input flex-grow-1" placeholder="TYPE SOMETHING..." style="font-size: 1.1rem;">
          <button [disabled]="!chatForm.valid" class="nb-btn px-4 py-2">SEND</button>
        </form>
      </div>

    </div>
  </div>
</main>

<app-modal />